tinymce.PluginManager.add("template",function(e){function t(){var e=new s;e.start()}function a(t,a){function n(e,t){if(e=""+e,e.length<t)for(var a=0;a<t-e.length;a++)e="0"+e;return e}var r="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),l="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),i="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),o="January February March April May June July August September October November December".split(" ");return a=a||new Date,t=t.replace("%D","%m/%d/%Y"),t=t.replace("%r","%I:%M:%S %p"),t=t.replace("%Y",""+a.getFullYear()),t=t.replace("%y",""+a.getYear()),t=t.replace("%m",n(a.getMonth()+1,2)),t=t.replace("%d",n(a.getDate(),2)),t=t.replace("%H",""+n(a.getHours(),2)),t=t.replace("%M",""+n(a.getMinutes(),2)),t=t.replace("%S",""+n(a.getSeconds(),2)),t=t.replace("%I",""+((a.getHours()+11)%12+1)),t=t.replace("%p",""+(a.getHours()<12?"AM":"PM")),t=t.replace("%B",""+e.translate(o[a.getMonth()])),t=t.replace("%b",""+e.translate(i[a.getMonth()])),t=t.replace("%A",""+e.translate(l[a.getDay()])),t=t.replace("%a",""+e.translate(r[a.getDay()])),t=t.replace("%%","%")}function n(t){var a=e.dom,n=e.getParam("template_replace_values");i(a.select("*",t),function(e){i(n,function(t,r){a.hasClass(e,r)&&"function"==typeof n[r]&&n[r](e)})})}function r(t,a){return i(e.getParam(a),function(e,a){"function"!=typeof e&&(t=t.replace(new RegExp("\\{\\$"+a+"\\}","g"),e))}),t}function l(t,l){function o(e,t){return new RegExp("\\b"+t+"\\b","g").test(e.className)}var s,c,p=e.dom,u=e.selection.getContent();l=r(l,"template_replace_values"),s=p.create("div",null,l),c=p.select(".mceTmpl",s),c&&c.length>0&&(s=p.create("div",null),s.appendChild(c[0].cloneNode(!0))),i(p.select("*",s),function(t){o(t,e.getParam("template_cdate_classes","cdate").replace(/\s+/g,"|"))&&(t.innerHTML=a(e.getParam("template_cdate_format",e.getLang("template.cdate_format")))),o(t,e.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(t.innerHTML=a(e.getParam("template_mdate_format",e.getLang("template.mdate_format")))),o(t,e.getParam("template_selected_content_classes","selcontent").replace(/\s+/g,"|"))&&(t.innerHTML=u)}),n(s),e.execCommand("mceInsertContent",!1,s.innerHTML),e.addVisual()}var i=tinymce.each,o=(tinymce.extend,function(e,t,a,n,r){var l=this,o=r?!1:!0,s={};return i(r,function(e,t){s[t]=e.value}),l.show=function(e){if(e.setCurrent(l),e.prepareParamsPopup(r),e.setDescription(n),t)if(o){var c=[];i(s,function(e,t){c.push(t+"="+e)}),tinymce.util.XHR.send({url:t+"?"+c.join("&"),success:function(t){e.setTemplate(t)}})}else e.setTemplate("");else e.setTemplate(a)},l.update=function(e){o=!0,s=e},l.isInitialized=function(){return o},{show:l.show,update:l.update,isInitialized:l.isInitialized}}),s=function(){var t=this,a=null,n=null,s=null,c=null,p=null,u="",m=null,d=[],f=[],g=[];return t.start=function(){var a=e.settings.templates;return a?("string"==typeof a?tinymce.util.XHR.send({url:a,success:function(e){t.show(tinymce.util.JSON.parse(e))}}):t.show(a),void 0):(e.windowManager.alert("No templates defined"),void 0)},t.show=function(n){a=e.windowManager.open(t.build(n)),c.fire("select")},t.build=function(a){return i(a,function(e){g.push({selected:!g.length,text:e.title,value:new o(e.title,e.url,e.content,e.description,e.options)})}),c=tinymce.ui.Factory.create({type:"listbox",name:"template",values:g,onselect:t.onSelectTemplate}),s=tinymce.ui.Factory.create({type:"button",icon:"template",text:"setup",onclick:t.showParamsSetup}),p=tinymce.ui.Factory.create({type:"label",name:"description",label:"Description",text:"Â "}),{title:"Insert template",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,body:[{type:"container",label:"Templates",items:[c,s]},{type:"container",label:"Description",items:[p]},{type:"iframe",minWidth:800,minHeight:300,border:1}],onsubmit:function(){l(!1,u)},width:e.getParam("template_popup_width",600),height:e.getParam("template_popup_height",500)}},t.setDescription=function(e){p.text(e)},t.setTemplate=function(t){if(u=t,-1==t.indexOf("<html>")){var n="";i(e.contentCSS,function(t){n+='<link type="text/css" rel="stylesheet" href="'+e.documentBaseURI.toAbsolute(t)+'">'}),t="<!DOCTYPE html><html><head>"+n+"</head><body>"+t+"</body></html>"}t=r(t,"template_preview_replace_values");var l=a.find("iframe")[0].getEl().contentWindow.document;l.open(),l.write(t),l.close()},t.prepareParamsPopup=function(a){d=[],f={},"undefined"==typeof a?s.hide():s.show(),i(a,function(e,t){var a=tinymce.ui.Factory.create(e);f[t]=a,d.push({type:"container",label:e.label,items:[a]})}),n=e.windowManager.open({title:"Template options",body:d,onsubmit:t.onParamsUpdate,onclose:t.onParamsClose}),n.hide()},t.setCurrent=function(e){m=e},t.onSelectTemplate=function(e){null!=n&&n.hide();var a=e.control.value();a.show(t),a.isInitialized()||t.showParamsSetup()},t.showParamsSetup=function(){n.show()},t.onParamsUpdate=function(){var e={};i(f,function(t,a){e[a]=t.value()}),m.update(e)},t.onParamsClose=function(){m.show(t)},{start:t.start,prepareParamsPopup:t.prepareParamsPopup,setDescription:t.setDescription,setTemplate:t.setTemplate,setCurrent:t.setCurrent}};e.addCommand("mceInsertTemplate",l),e.addButton("template",{title:"Insert template",onclick:t}),e.addMenuItem("template",{text:"Insert template",onclick:t,context:"insert"}),e.on("PreProcess",function(t){var r=e.dom;i(r.select("div",t.node),function(t){r.hasClass(t,"mceTmpl")&&(i(r.select("*",t),function(t){r.hasClass(t,e.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(t.innerHTML=a(e.getParam("template_mdate_format",e.getLang("template.mdate_format"))))}),n(t))})})});